From 2b8f6be3ad2973ac972c28615366bfc9badb4609 Mon Sep 17 00:00:00 2001
From: Pawel Zalewski <pzalewski@thegoodpenguin.co.uk>
Date: Mon, 27 Nov 2023 10:32:37 +0000
Subject: [PATCH 06/10] embed: use padding of 16 not 8 for allocators

Signed-off-by: Pawel Zalewski <pzalewski@thegoodpenguin.co.uk>
---
 include/memalloc.h        |  4 ++--
 src/libs/zbxembed/embed.c | 22 ++++++++++++----------
 2 files changed, 14 insertions(+), 12 deletions(-)

diff --git a/include/memalloc.h b/include/memalloc.h
index 5f7e3683388..41c0e28385b 100644
--- a/include/memalloc.h
+++ b/include/memalloc.h
@@ -26,8 +26,8 @@
 #define MEM_MIN_ALLOC	(3*ZBX_PTR_SIZE)	/* should be a multiple of 8 and at least (2 * ZBX_PTR_SIZE) */
 
 #define MEM_MIN_BUCKET_SIZE	MEM_MIN_ALLOC
-#define MEM_MAX_BUCKET_SIZE	256 /* starting from this size all free chunks are put into the same bucket */
-#define MEM_BUCKET_COUNT	((MEM_MAX_BUCKET_SIZE - MEM_MIN_BUCKET_SIZE) / 8 + 1)
+#define MEM_MAX_BUCKET_SIZE	512 /* starting from this size all free chunks are put into the same bucket */
+#define MEM_BUCKET_COUNT	((MEM_MAX_BUCKET_SIZE - MEM_MIN_BUCKET_SIZE) / 16 + 1)
 
 typedef struct
 {
diff --git a/src/libs/zbxembed/embed.c b/src/libs/zbxembed/embed.c
index 407c8e0d7c0..187ef0edc19 100644
--- a/src/libs/zbxembed/embed.c
+++ b/src/libs/zbxembed/embed.c
@@ -28,8 +28,10 @@
 
 #include "duktape.h"
 
-#define ZBX_ES_MEMORY_LIMIT	(1024 * 1024 * 64)
-#define ZBX_ES_STACK_LIMIT	1000
+#define ZBX_ES_MEMORY_LIMIT	(1024 * 1024 * 128)
+#define ZBX_ES_STACK_LIMIT	(1000*2)
+
+#define ZBX_ES_PAD			(16)
 
 /* maximum number of consequent runtime errors after which it's treated as fatal error */
 #define ZBX_ES_MAX_CONSEQUENT_RT_ERROR	3
@@ -64,7 +66,7 @@ static void	*es_malloc(void *udata, duk_size_t size)
 	zbx_es_env_t	*env = (zbx_es_env_t *)udata;
 	uint64_t	*uptr;
 
-	if (env->total_alloc + size + 8 > ZBX_ES_MEMORY_LIMIT)
+	if (env->total_alloc + size + ZBX_ES_PAD > ZBX_ES_MEMORY_LIMIT)
 	{
 		if (NULL == env->ctx)
 			env->error = zbx_strdup(env->error, "cannot allocate memory");
@@ -72,8 +74,8 @@ static void	*es_malloc(void *udata, duk_size_t size)
 		return NULL;
 	}
 
-	env->total_alloc += (size + 8);
-	uptr = zbx_malloc(NULL, size + 8);
+	env->total_alloc += (size + ZBX_ES_PAD);
+	uptr = zbx_malloc(NULL, size + ZBX_ES_PAD);
 	*uptr++ = size;
 
 	return uptr;
@@ -88,12 +90,12 @@ static void	*es_realloc(void *udata, void *ptr, duk_size_t size)
 	if (NULL != uptr)
 	{
 		--uptr;
-		old_size = *uptr + 8;
+		old_size = *uptr + ZBX_ES_PAD;
 	}
 	else
 		old_size = 0;
 
-	if (env->total_alloc + size + 8 - old_size > ZBX_ES_MEMORY_LIMIT)
+	if (env->total_alloc + size + ZBX_ES_PAD - old_size > ZBX_ES_MEMORY_LIMIT)
 	{
 		if (NULL == env->ctx)
 			env->error = zbx_strdup(env->error, "cannot allocate memory");
@@ -101,8 +103,8 @@ static void	*es_realloc(void *udata, void *ptr, duk_size_t size)
 		return NULL;
 	}
 
-	env->total_alloc += size + 8 - old_size;
-	uptr = zbx_realloc(uptr, size + 8);
+	env->total_alloc += size + ZBX_ES_PAD - old_size;
+	uptr = zbx_realloc(uptr, size + ZBX_ES_PAD);
 	*uptr++ = size;
 
 	return uptr;
@@ -115,7 +117,7 @@ static void	es_free(void *udata, void *ptr)
 
 	if (NULL != ptr)
 	{
-		env->total_alloc -= (*(--uptr) + 8);
+		env->total_alloc -= (*(--uptr) + ZBX_ES_PAD);
 		zbx_free(uptr);
 	}
 }
-- 
2.47.1

