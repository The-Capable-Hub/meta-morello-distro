From 8f033a46006ed32e1eda5876426f0bdf0682f263 Mon Sep 17 00:00:00 2001
From: Pawel Zalewski <pzalewski@thegoodpenguin.co.uk>
Date: Tue, 28 Nov 2023 14:02:26 +0000
Subject: [PATCH 05/10] duktape: add aling to 16

Signed-off-by: Pawel Zalewski <pzalewski@thegoodpenguin.co.uk>
---
 src/libs/zbxembed/duk_config.h |  2 +-
 src/libs/zbxembed/duktape.c    | 18 ++++++++++++++++++
 2 files changed, 19 insertions(+), 1 deletion(-)

diff --git a/src/libs/zbxembed/duk_config.h b/src/libs/zbxembed/duk_config.h
index e172f6ad292..d4c036eb858 100644
--- a/src/libs/zbxembed/duk_config.h
+++ b/src/libs/zbxembed/duk_config.h
@@ -2592,7 +2592,7 @@ typedef struct duk_hthread duk_context;
 
 /* If not forced, use safe default for alignment. */
 #if !defined(DUK_USE_ALIGN_BY)
-#define DUK_USE_ALIGN_BY 8
+#define DUK_USE_ALIGN_BY 16
 #endif
 
 /* Compiler specific hackery needed to force struct size to match alignment,
diff --git a/src/libs/zbxembed/duktape.c b/src/libs/zbxembed/duktape.c
index e3b439f6e3a..fdd8ef9fe5b 100644
--- a/src/libs/zbxembed/duktape.c
+++ b/src/libs/zbxembed/duktape.c
@@ -6933,6 +6933,8 @@ DUK_INTERNAL_DECL void duk_hobject_assert_valid(duk_hobject *h);
 #define DUK_HOBJECT_E_FLAG_PADDING(e_sz) ((8 - (e_sz)) & 0x07)
 #elif (DUK_USE_ALIGN_BY == 1)
 #define DUK_HOBJECT_E_FLAG_PADDING(e_sz) 0
+#elif (DUK_USE_ALIGN_BY == 16)
+#define DUK_HOBJECT_E_FLAG_PADDING(e_sz) ((16 - (e_sz)) & 0xF)
 #else
 #error invalid DUK_USE_ALIGN_BY
 #endif
@@ -7242,6 +7244,8 @@ DUK_INTERNAL_DECL void duk_hobject_assert_valid(duk_hobject *h);
 #define DUK_HOBJECT_ALIGN_TARGET 8
 #elif (DUK_USE_ALIGN_BY == 1)
 #define DUK_HOBJECT_ALIGN_TARGET 1
+#elif (DUK_USE_ALIGN_BY == 16)
+#define DUK_HOBJECT_ALIGN_TARGET 16
 #else
 #error invalid DUK_USE_ALIGN_BY
 #endif
@@ -8813,9 +8817,15 @@ struct duk_hbuffer_fixed {
 		duk_uint32_t dummy_for_align4;
 #elif (DUK_USE_ALIGN_BY == 8)
 		duk_double_t dummy_for_align8_1;
+#elif (DUK_USE_ALIGN_BY == 16)
+		void* dummy_for_align16_1;
 #if defined(DUK_USE_64BIT_OPS)
+#if (DUK_USE_ALIGN_BY == 16)
+		void* dummy_for_align8_2;
+#else
 		duk_uint64_t dummy_for_align8_2;
 #endif
+#endif
 #elif (DUK_USE_ALIGN_BY == 1)
 		/* no extra padding */
 #else
@@ -8844,6 +8854,8 @@ __attribute__((aligned(8)))
 ;
 #if (DUK_USE_ALIGN_BY == 8) && defined(DUK_USE_PACK_MSVC_PRAGMA)
 #pragma pack(pop)
+#elif (DUK_USE_ALIGN_BY == 16) && defined(DUK_USE_PACK_MSVC_PRAGMA)
+#pragma pack(pop)
 #endif
 
 /* Dynamic buffer with 'curr_alloc' pointing to a dynamic area allocated using
@@ -65392,6 +65404,8 @@ DUK_INTERNAL void duk_hthread_create_builtin_objects(duk_hthread *thr) {
 	                "a8"
 #elif (DUK_USE_ALIGN_BY == 1)
 	                "a1"
+#elif (DUK_USE_ALIGN_BY == 16)
+	                "a16"
 #else
 #error invalid DUK_USE_ALIGN_BY
 #endif
@@ -93466,6 +93480,10 @@ DUK_LOCAL duk_uint_t duk__selftest_struct_align(void) {
 	if ((sizeof(duk_hbuffer_fixed) % 8) != 0) {
 		DUK__FAILED("sizeof(duk_hbuffer_fixed) not aligned to 8");
 	}
+#elif (DUK_USE_ALIGN_BY == 16)
+	if ((sizeof(duk_hbuffer_fixed) % 16) != 0) {
+		DUK__FAILED("sizeof(duk_hbuffer_fixed) not aligned to 16");
+	}
 #elif (DUK_USE_ALIGN_BY == 1)
 	/* no check */
 #else
-- 
2.47.1

