From 8c7150407029080b7f8598559d43606f44e23c8b Mon Sep 17 00:00:00 2001
From: Michael Cobb <michael.cobb@iceotope.com>
Date: Wed, 12 Jun 2024 10:15:39 +0100
Subject: [PATCH] fix iconv/libintl library not found

---
 meson.build       | 19 +++++++++++++++++--
 meson_options.txt |  6 ++++++
 2 files changed, 23 insertions(+), 2 deletions(-)

diff --git a/meson.build b/meson.build
index 73523db34..31f90ece1 100644
--- a/meson.build
+++ b/meson.build
@@ -2043,12 +2043,27 @@ glibconfig_conf.set10('G_HAVE_GROWING_STACK', growing_stack)
 # We should never use the MinGW C library's iconv because it may not be
 # available in the actual runtime environment. On Windows, we always use
 # the built-in implementation
+iconv_opt = get_option('iconv')
 if host_system == 'windows'
+  libiconv = []
   # We have a #include "win_iconv.c" in gconvert.c on Windows, so we don't need
   # any external library for it
-  libiconv = []
+  if iconv_opt != 'auto'
+    warning('-Diconv was set to @0@, which was ignored')
+  endif
 else
-  libiconv = dependency('iconv')
+  found_iconv = false
+  if ['auto', 'libc'].contains(iconv_opt) and cc.has_function('iconv_open')
+    libiconv = []
+    found_iconv = true
+  endif
+  if not found_iconv and ['auto', 'external'].contains(iconv_opt) and cc.has_header_symbol('iconv.h', 'iconv_open')
+    libiconv = [cc.find_library('iconv')]
+    found_iconv = true
+  endif
+  if not found_iconv
+    error('iconv implementation "@0@" not found'.format(iconv_opt))
+  endif
 endif
 
 pcre2_req = '>=10.32'
diff --git a/meson_options.txt b/meson_options.txt
index 09ddc9318..324351cf7 100644
--- a/meson_options.txt
+++ b/meson_options.txt
@@ -4,6 +4,12 @@ option('runtime_libdir',
        description : 'install runtime libraries relative to libdir',
        deprecated: true)
 
+option('iconv',
+       type : 'combo',
+       choices : ['auto', 'libc', 'external'],
+       value : 'auto',
+       description : 'iconv implementation to use (\'libc\' = \'Part of the C library\'; \'external\' = \'External libiconv\'; \'auto\' = \'Auto-detect which iconv is available\')')
+
 option('charsetalias_dir',
        type : 'string',
        value : '',
